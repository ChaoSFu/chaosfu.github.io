name: Build & Deploy Daily Data

on:
  schedule:
    # äº¤æ˜“æ—¶æ®µæ¯5åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
    # ä¸Šåˆï¼š9:30-11:30 åŒ—äº¬æ—¶é—´ = 1:30-3:30 UTC
    # ä¸‹åˆï¼š13:00-15:00 åŒ—äº¬æ—¶é—´ = 5:00-7:00 UTC
    - cron: '*/5 1-3,5-6 * * 1-5'   # UTC 1:00-3:55, 5:00-6:55 (åŒ—äº¬æ—¶é—´ 9:00-11:55, 13:00-14:55)
  workflow_dispatch: {}

jobs:
  etl:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: pip install -r stock-analysis/scripts/requirements.txt

      - name: Run ETL (Fetch Real Data from Eastmoney)
        env:
          MODE: "EASTMONEY"  # EASTMONEY=ä¸œæ–¹è´¢å¯Œå®æ—¶æ•°æ®(æ¨è) / MOCK=æµ‹è¯•æ•°æ® / CSV / API
        run: |
          python stock-analysis/scripts/etl_daily.py \
            --mode "${MODE}" \
            --top-boards 20 \
            --stocks-per-board 10 \
            --out "stock-analysis/data/daily.json" \
            --archive-dir "stock-analysis/data/archive" \
            --enable-history \
            --history-days 7

          # æ³¨æ„ï¼šetl_daily.py å·²å†…ç½®äº¤æ˜“æ—¥å’Œäº¤æ˜“æ—¶é—´æ£€æµ‹
          # å¦‚æœä¸åœ¨äº¤æ˜“æ—¶é—´å†…ï¼ˆ9:30-11:30, 13:00-15:00ï¼‰ï¼Œè„šæœ¬ä¼šè‡ªåŠ¨è·³è¿‡
          # å‘¨æœ«å’Œéäº¤æ˜“æ—¶é—´ä¸ä¼šç”Ÿæˆæˆ–æ›´æ–°ä»»ä½•æ•°æ®

      - name: Commit and Push Data to Main Branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add stock-analysis/data/
          git diff --staged --quiet || git commit -m "Auto-update stock data $(date +%Y-%m-%d)

          ğŸ“Š Updated by GitHub Actions
          - Daily data: stock-analysis/data/daily.json
          - History data: stock-analysis/data/history.json
          - Archive: stock-analysis/data/archive/$(date +%Y-%m-%d).json
          "
          git push
