name: Build & Deploy Daily Data

on:
  schedule:
    # äº¤æ˜“æ—¶æ®µæ¯5åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
    # ä½¿ç”¨éæ•´ç‚¹åˆ†é’Ÿï¼ˆ2,7,12,17...ï¼‰ä»¥é¿å¼€ GitHub Actions é«˜è´Ÿè½½æ—¶æ®µ
    # è¦†ç›–æ—¶æ®µï¼š
    #   ä¸Šåˆ 9:30-11:30 åŒ—äº¬æ—¶é—´ = UTC 1:30-3:30
    #   ä¸‹åˆ 13:00-15:00 åŒ—äº¬æ—¶é—´ = UTC 5:00-7:00
    - cron: '2,7,12,17,22,27,32,37,42,47,52,57 1-3,5-7 * * 1-5'  # é¿å¼€æ•´ç‚¹ï¼Œå‡å°‘å»¶è¿Ÿ
  workflow_dispatch:
    inputs:
      skip_time_check:
        description: 'è·³è¿‡äº¤æ˜“æ—¶é—´æ£€æµ‹ï¼ˆç”¨äºæ‰‹åŠ¨æµ‹è¯•ï¼‰'
        required: false
        default: 'true'
        type: boolean

jobs:
  etl:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: pip install -r stock-analysis/scripts/requirements.txt

      - name: Run ETL (Fetch Real Data from Eastmoney)
        env:
          MODE: "EASTMONEY"  # EASTMONEY=ä¸œæ–¹è´¢å¯Œå®æ—¶æ•°æ®(æ¨è) / MOCK=æµ‹è¯•æ•°æ® / CSV / API
        run: |
          # æ„å»ºå‘½ä»¤å‚æ•°
          SKIP_CHECK=""
          if [ "${{ github.event.inputs.skip_time_check }}" = "true" ]; then
            SKIP_CHECK="--skip-trading-day-check"
          fi

          python stock-analysis/scripts/etl_daily.py \
            --mode "${MODE}" \
            --top-boards 20 \
            --stocks-per-board 10 \
            --out "stock-analysis/data/daily.json" \
            --archive-dir "stock-analysis/data/archive" \
            --enable-history \
            --history-days 7 \
            ${SKIP_CHECK}

          # æ³¨æ„ï¼šetl_daily.py å·²å†…ç½®äº¤æ˜“æ—¥å’Œäº¤æ˜“æ—¶é—´æ£€æµ‹
          # å¦‚æœä¸åœ¨äº¤æ˜“æ—¶é—´å†…ï¼ˆ9:30-11:30, 13:00-15:00ï¼‰ï¼Œè„šæœ¬ä¼šè‡ªåŠ¨è·³è¿‡
          # æ‰‹åŠ¨è§¦å‘æ—¶é»˜è®¤è·³è¿‡æ—¶é—´æ£€æµ‹ï¼Œç”¨äºæµ‹è¯•å’Œè¡¥æ•°æ®

      - name: Commit and Push Data to Main Branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add stock-analysis/data/
          git diff --staged --quiet || git commit -m "Auto-update stock data $(date +%Y-%m-%d)

          ğŸ“Š Updated by GitHub Actions
          - Daily data: stock-analysis/data/daily.json
          - History data: stock-analysis/data/history.json
          - Archive: stock-analysis/data/archive/$(date +%Y-%m-%d).json
          "
          git push
