name: Build & Deploy Daily Data

on:
  schedule:
    - cron: '10 7 * * 1-5'   # UTC 07:10 â‰ˆ åŒ—äº¬æ—¶é—´ 15:10 å·¥ä½œæ—¥
  workflow_dispatch: {}

jobs:
  etl:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps
        run: pip install -r stock-analysis/scripts/requirements.txt

      - name: Run ETL (Fetch Real Data from Eastmoney)
        env:
          MODE: "EASTMONEY"  # EASTMONEY=ä¸œæ–¹è´¢å¯Œå®æ—¶æ•°æ®(æ¨è) / MOCK=æµ‹è¯•æ•°æ® / CSV / API
        run: |
          python stock-analysis/scripts/etl_daily.py \
            --mode "${MODE}" \
            --top-boards 20 \
            --stocks-per-board 10 \
            --out "stock-analysis/data/daily.json"

      - name: Archive Today's Data
        run: |
          TODAY=$(date +%Y-%m-%d)
          mkdir -p stock-analysis/data/archive
          cp stock-analysis/data/daily.json "stock-analysis/data/archive/${TODAY}.json"
          echo "âœ… Archived today's data to archive/${TODAY}.json"

      - name: Generate History Data
        run: |
          python stock-analysis/scripts/generate_history.py \
            --archive-dir stock-analysis/data/archive \
            --days 7 \
            --out stock-analysis/data/history.json

      - name: Commit and Push Data to Main Branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add stock-analysis/data/
          git diff --staged --quiet || git commit -m "Auto-update stock data $(date +%Y-%m-%d)

          ğŸ“Š Updated by GitHub Actions
          - Daily data: stock-analysis/data/daily.json
          - History data: stock-analysis/data/history.json
          - Archive: stock-analysis/data/archive/$(date +%Y-%m-%d).json
          "
          git push
